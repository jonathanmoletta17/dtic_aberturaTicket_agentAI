kind: AdaptiveDialog
modelDescription: T√≥pico para coletar detalhes de incidentes t√©cnicos (t√≠tulo, descri√ß√£o, categoria, impacto, localiza√ß√£o e contato telef√¥nico) e abrir um novo chamado completo no sistema GLPI via requisi√ß√£o POST para a API do Agente.
beginDialog:
  kind: OnRecognizedIntent
  id: main
  intent:
    triggerQueries:
      - criar chamado
      - abrir ticket
      - preciso de ajuda
      - reportar problema
      - novo chamado
      - solicitar suporte
      - problema t√©cnico
      - ajuda com equipamento
      - fazer um ticket
      - tenho um problema
    allowsInvocation: true

  actions:
    - kind: HttpRequestAction
      id: LookupUser
      method: Get
      url: ="https://minute-shots-kick-flying.trycloudflare.com/api/glpi-user-by-email?email=" & Trim(System.User.Email)
      headers:
        Accept: application/json

      response: Topic.userLookup
      responseSchema: Any

    - kind: ConditionGroup
      id: CheckLookup
      conditions:
        - id: FoundUser
          condition: =Boolean(Topic.userLookup.sucesso) && Boolean(Topic.userLookup.resultado.found)
          actions:
            - kind: SetVariable
              id: SetUserId
              variable: Topic.glpi_user_id
              value: =Topic.userLookup.resultado.user_id

            - kind: SetVariable
              id: SetUserLogin
              variable: Topic.glpi_user_login
              value: =Topic.userLookup.resultado.login

            - kind: SetVariable
              id: SetUserName
              variable: Topic.glpi_user_name
              value: =Topic.userLookup.resultado.name

            - kind: SetVariable
              id: SetValidated
              variable: Topic.user_email_validated
              value: true

            - kind: SendActivity
              id: ConfirmFound
              activity: |
                ‚úÖ Usu√°rio GLPI encontrado: {Topic.userLookup.resultado.name} ({Topic.userLookup.resultado.login}). Continuaremos com esta informa√ß√£o.

      elseActions:
        - kind: SetVariable
          id: SetNotValidated
          variable: Topic.user_email_validated
          value: false

        - kind: SendActivity
          id: NotFound
          activity: |
            ‚ùå Usu√°rio GLPI n√£o encontrado. O chamado ser√° criado sem v√≠nculo de requerente.

    - kind: AnswerQuestionWithAI
      id: GAExtract
      autoSend: false
      variable: Topic.ga_text
      userInput: =System.Activity.Text
      additionalInstructions: |-
        Voc√™ √© um assistente que extrai campos estruturados para abertura de chamados.
        A partir da √∫ltima mensagem do usu√°rio (inten√ß√£o: abrir chamado), identifique:
        - title: resumo curto do incidente
        - description: descri√ß√£o detalhada
        - category: uma das op√ß√µes [HARDWARE_COMPUTADOR, HARDWARE_IMPRESSORA, HARDWARE_MONITOR, SOFTWARE, CONECTIVIDADE, SEGURANCA, SOLICITACAO, OUTROS]
        - impact: uma das op√ß√µes [BAIXO, MEDIO, ALTO, MUITO_ALTO, CRITICO]
        - location: local ou unidade onde ocorre
        - contact_phone: telefone de contato

        Regras:
        - Responda APENAS com um JSON v√°lido, sem texto adicional.
        - N√£o use blocos de c√≥digo Markdown.
        - N√£o use backticks (```), nem prefixo "json".
        - Retorne apenas um objeto JSON. Inicie com o caractere de abertura de chave e termine com o de fechamento.
        - Use MAI√öSCULO para category e impact.
        - Se um campo n√£o estiver presente, use null.
        - N√£o invente informa√ß√µes; apenas extraia o que est√° dito ou infer√≠vel com seguran√ßa.

    - kind: SetVariable
      id: ParseGA
      variable: Topic.ga_json
      value: =IfError(If(!IsBlank(Topic.ga_text), ParseJSON(Topic.ga_text), Blank()), Blank())

    - kind: SetVariable
      id: SetFromGA_Title
      variable: Topic.title
      value: =If(IsBlank(Topic.title), IfError(Text(Topic.ga_json.title), Blank()), Topic.title)

    - kind: SetVariable
      id: SetFromGA_Description
      variable: Topic.description
      value: =If(IsBlank(Topic.description), IfError(Text(Topic.ga_json.description), Blank()), Topic.description)

    - kind: SetVariable
      id: SetFromGA_Category
      variable: Topic.category_user_friendly
      value: =If(IsBlank(Topic.category_user_friendly), IfError(Upper(Text(Topic.ga_json.category)), Blank()), Topic.category_user_friendly)

    - kind: SetVariable
      id: SetFromGA_Impact
      variable: Topic.impact
      value: =If(IsBlank(Topic.impact), IfError(Upper(Text(Topic.ga_json.impact)), Blank()), Topic.impact)

    - kind: SetVariable
      id: SetFromGA_Location
      variable: Topic.location
      value: =If(IsBlank(Topic.location), IfError(Text(Topic.ga_json.location), Blank()), Topic.location)

    - kind: SetVariable
      id: SetFromGA_Phone
      variable: Topic.contact_phone
      value: =If(IsBlank(Topic.contact_phone), IfError(Text(Topic.ga_json.contact_phone), Blank()), Topic.contact_phone)

    - kind: Question
      id: GetTitle
      variable: Topic.title
      prompt: |
        üìù T√≠tulo do Chamado (obrigat√≥rio):
        Ex: Impressora da Sala 101 n√£o liga; Problema de acesso ao sistema X
      entity: StringPrebuiltEntity

    - kind: Question
      id: GetDescription
      variable: Topic.description
      prompt: |
        üìã Descri√ß√£o detalhada (m√≠n. 50 caracteres):
        Descreva o incidente com o m√°ximo de detalhes poss√≠vel.
      entity: StringPrebuiltEntity

    - kind: Question
      id: GetCategory
      variable: Topic.category_user_friendly
      prompt: |
        üìÇ Categoria (obrigat√≥rio, em MAI√öSCULO):
        HARDWARE_COMPUTADOR, HARDWARE_IMPRESSORA, HARDWARE_MONITOR,
        SOFTWARE, CONECTIVIDADE, SEGURANCA, SOLICITACAO, OUTROS
      entity: StringPrebuiltEntity

    - kind: Question
      id: GetImpact
      variable: Topic.impact
      prompt: |
        ‚ö° Impacto (obrigat√≥rio, em MAI√öSCULO; padr√£o MEDIO):
        BAIXO, MEDIO, ALTO, MUITO_ALTO, CRITICO
      entity: StringPrebuiltEntity

    - kind: Question
      id: GetLocation
      variable: Topic.location
      prompt: |
        üìç Localiza√ß√£o (obrigat√≥rio):
        Ex: Escrit√≥rio - Sala 101; Filial Porto Alegre; Pr√©dio B - 3¬∫ andar
      entity: StringPrebuiltEntity

    - kind: Question
      id: GetPhone
      variable: Topic.contact_phone
      prompt: |
        üìû Telefone de contato (obrigat√≥rio, m√≠nimo 8 caracteres):
        Ex: 51999999999
      entity: StringPrebuiltEntity

    - kind: SetVariable
      id: NormalizePhone
      variable: Topic.contact_phone
      value: =If(IsBlank(Topic.contact_phone), Blank(), Substitute(Substitute(Substitute(Substitute(Text(Topic.contact_phone), " ", ""), "-", ""), "(", ""), ")", ""))

    - kind: HttpRequestAction
      id: CreateTicket
      method: Post
      url: ="https://minute-shots-kick-flying.trycloudflare.com/api/create-ticket-complete"
      headers:
        Accept: application/json
        Content-Type: application/json; charset=utf-8

      body:
        kind: JsonRequestContent
        content: |-
          ={
            title: If(IsBlank(Topic.title), "Chamado via Copilot Studio", Text(Topic.title)),
            description: Topic.description,
            category: Upper(If(IsBlank(Topic.category_user_friendly), "OUTROS", Text(Topic.category_user_friendly))),
            impact: Upper(If(IsBlank(Topic.impact), "MEDIO", Text(Topic.impact))),
            location: Topic.location,
            contact_phone: Topic.contact_phone,
            requester_email: If(Boolean(Topic.user_email_validated) && !IsBlank(Topic.userLookup.resultado.email), Text(Topic.userLookup.resultado.email), Text(System.User.Email))
          }

      response: Topic.createTicketResponse
      responseSchema: Any

    - kind: ConditionGroup
      id: CheckCreateTicket
      conditions:
        - id: Success
          condition: =Boolean(Topic.createTicketResponse.sucesso)
          actions:
            - kind: SetVariable
              id: SetTicketId
              variable: Topic.ticket_id
              value: =Topic.createTicketResponse.ticket_id

            - kind: SendActivity
              id: ConfirmCreated
              activity: |-
                üé´ Chamado criado com sucesso!
                N√∫mero: {Topic.ticket_id}
                Categoria: {Topic.category_user_friendly}
                Impacto: {Topic.impact}
                Local: {Topic.location}
                Telefone: {If(IsBlank(Topic.contact_phone), "N√£o informado", Topic.contact_phone)}

        - id: Failure
          condition: =Not(Boolean(Topic.createTicketResponse.sucesso))
          actions:
            - kind: SendActivity
              id: ReportError
              activity: |
                ‚ùå Falha ao criar o chamado.
                Erro: {Topic.createTicketResponse.erro}
                Trace: {Topic.createTicketResponse.trace_id}

    - kind: EndDialog
      id: EYlGOV

inputType: {}
outputType: {}
variables:
  - name: Topic.ga_text
    type: string

  - name: Topic.ga_json
    type: any

  - name: Topic.user_email
    type: string

  - name: Topic.user_email_validated
    type: boolean

  - name: Topic.userLookup
    type: any

  - name: Topic.glpi_user_id
    type: number

  - name: Topic.glpi_user_login
    type: string

  - name: Topic.glpi_user_name
    type: string

  - name: Topic.title
    type: string

  - name: Topic.description
    type: string

  - name: Topic.category_user_friendly
    type: string

  - name: Topic.impact
    type: string

  - name: Topic.location
    type: string

  - name: Topic.contact_phone
    type: string

  - name: Topic.createTicketResponse
    type: any

  - name: Topic.ticket_id
    type: number