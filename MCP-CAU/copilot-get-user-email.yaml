kind: AdaptiveDialog
modelDescription: T√≥pico minimalista para obter e validar o e-mail do usu√°rio

beginDialog:
  kind: OnRecognizedIntent
  id: getUserEmail
  intent:
    triggerQueries:
      - meu email
      - meu e-mail
      - qual meu email
      - qual meu e-mail
      - qual √© meu email
      - qual √© meu e-mail
      - capturar email
      - capturar e-mail
      - coletar email
      - coletar e-mail
      - email 365
      - e-mail 365
      - pegar meu email
      - pegar meu e-mail
      - meu endere√ßo de email
      - meu endere√ßo de e-mail
      - qual √© o meu email
      - qual √© o meu e-mail

  actions:
    - kind: SendActivity
      id: Intro
      activity: |
        üìß Por favor, informe seu e‚Äëmail corporativo.

    - kind: Question
      id: AskEmail
      alwaysPrompt: true
      variable: Topic.user_email
      prompt: |
        Digite seu e‚Äëmail (ex: nome@empresa.com):
      entity: StringPrebuiltEntity

    - kind: HttpRequestAction
      id: LookupUser
      method: Get
      url: ="https://concentrate-retrieved-farmer-feeling.trycloudflare.com/api/glpi-user-by-email?email=" & Trim(Topic.user_email)
      headers:
        Accept: application/json
      response: Topic.userLookup
      responseSchema: Any

    - kind: ConditionGroup
      id: CheckLookup
      conditions:
        - id: FoundUser
          condition: =Boolean(Topic.userLookup.sucesso) && Boolean(Topic.userLookup.resultado.found)
          actions:
            - kind: SetVariable
              id: SetUserId
              variable: Topic.glpi_user_id
              value: =Topic.userLookup.resultado.user_id
            - kind: SetVariable
              id: SetUserLogin
              variable: Topic.glpi_user_login
              value: =Topic.userLookup.resultado.login
            - kind: SetVariable
              id: SetUserName
              variable: Topic.glpi_user_name
              value: =Topic.userLookup.resultado.name
            - kind: SetVariable
              id: SetValidated
              variable: Topic.user_email_validated
              value: true
            - kind: SendActivity
              id: ConfirmFound
              activity: |
                ‚úÖ Usu√°rio GLPI encontrado: {Topic.userLookup.resultado.name} ({Topic.userLookup.resultado.login})
                üì¨ E‚Äëmail validado: {Topic.userLookup.resultado.email}
      elseActions:
        - kind: SetVariable
          id: SetNotValidated
          variable: Topic.user_email_validated
          value: false
        - kind: SendActivity
          id: NotFound
          activity: |
            ‚ùå N√£o encontramos um usu√°rio no GLPI com este e‚Äëmail.
            Verifique se digitou corretamente (ex: nome@empresa.com). Voc√™ pode prosseguir, mas o requerente n√£o ser√° vinculado.

    - kind: SendActivity
      id: FinalMessage
      activity: |
        üì¨ E‚Äëmail registrado: {Topic.user_email}
        üîó Valida√ß√£o: {If(Topic.user_email_validated, "v√°lido", "n√£o encontrado")}

variables:
  - name: Topic.user_email
    type: string
    default: ""
  - name: Topic.userLookup
    type: any
  - name: Topic.user_email_validated
    type: boolean
    default: false
  - name: Topic.glpi_user_id
    type: number
  - name: Topic.glpi_user_login
    type: string
  - name: Topic.glpi_user_name
    type: string