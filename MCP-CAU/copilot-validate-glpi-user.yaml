kind: AdaptiveDialog
modelDescription: Resolve usuário GLPI pelo email do usuário atual e retorna campos padronizados.
beginDialog:
  kind: OnRecognizedIntent
  id: main
  intent: {}
  actions:
    - kind: HttpRequestAction
      id: LookupUser
      method: Get
      url: = "https://justify-intermediate-hamilton-assessment.trycloudflare.com/api/glpi-user-by-email?email=" & Trim(System.User.Email)
      headers:
        Accept: application/json

      response: Topic.userLookup
      responseSchema: Any

    - kind: ConditionGroup
      id: CheckLookup
      conditions:
        - id: FoundUser
          condition: =Boolean(Topic.userLookup.sucesso) && Boolean(Topic.userLookup.resultado.found)
          actions:
            - kind: SetVariable
              id: SetUserId
              variable: Topic.glpi_user_id
              value: =Topic.userLookup.resultado.user_id

            - kind: SetVariable
              id: SetUserLogin
              variable: Topic.glpi_user_login
              value: =Topic.userLookup.resultado.login

            - kind: SetVariable
              id: SetUserName
              variable: Topic.glpi_user_name
              value: =Topic.userLookup.resultado.name

            - kind: SetVariable
              id: SetValidated
              variable: Topic.user_email_validated
              value: true

      elseActions:
        - kind: SetVariable
          id: SetNotValidated
          variable: Topic.user_email_validated
          value: false

        - kind: SendActivity
          id: NotFound
          activity: |
            ❌ Usuário GLPI não encontrado. O chamado será criado sem vínculo de requerente.

    - kind: EndDialog
      id: end

inputType:
  properties:
    user_email_validated:
      displayName: user_email_validated
      type: Boolean

outputType:
  properties:
    glpi_user_id:
      displayName: glpi_user_id
      type: Any

    glpi_user_login:
      displayName: glpi_user_login
      type: Any

    glpi_user_name:
      displayName: glpi_user_name
      type: Any

    user_email_validated:
      displayName: user_email_validated
      type: Boolean

    userLookup:
      displayName: userLookup
      type: Any