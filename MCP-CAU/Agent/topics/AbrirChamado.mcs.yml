# Name: AbrirChamado
kind: AdaptiveDialog
modelDescription: T√≥pico para cria√ß√£o de chamados e tickets de suporte t√©cnico no sistema GLPI
beginDialog:
  kind: OnRecognizedIntent
  id: main
  intent:
    triggerQueries:
      - criar chamado
      - abrir ticket
      - preciso de ajuda
      - reportar problema
      - criar ticket
      - novo chamado
      - solicitar suporte
      - minha impressora n√£o funciona
      - problema com impressora
      - impressora com defeito
      - equipamento n√£o funciona
      - problema t√©cnico
      - suporte t√©cnico
      - ajuda com equipamento
      - abrir um chamado
      - fazer um ticket
      - registrar problema
      - tenho um problema
      - preciso de suporte
      - criar um ticket
      - abrir um ticket
      - fazer chamado

  actions:
    - kind: SendActivity
      id: WelcomeMessage
      activity: |
        üé´ **Vamos criar seu chamado!**

        Por favor, forne√ßa as seguintes informa√ß√µes:

    - kind: Question
      id: GetCategory
      alwaysPrompt: true
      variable: Topic.category_user_friendly
      prompt: |
        üìÇ **Categoria do problema** (obrigat√≥rio):

        Selecione a categoria que melhor descreve seu problema:

        üñ•Ô∏è **HARDWARE_COMPUTADOR** - Computador/Notebook
        üñ®Ô∏è **HARDWARE_IMPRESSORA** - Impressora  
        üì∫ **HARDWARE_MONITOR** - Monitor/Equipamentos
        üíª **SOFTWARE** - Aplicativos/Programas
        üåê **CONECTIVIDADE** - Internet/Rede
        üîê **SEGURANCA** - Acesso/Login
        üìã **SOLICITACAO** - Instala√ß√£o/Configura√ß√£o
        ‚ùì **OUTROS** - N√£o listado acima

        Digite exatamente uma das op√ß√µes em mai√∫sculo (ex: HARDWARE_COMPUTADOR):
      entity: StringPrebuiltEntity

    - kind: Question
      id: GetDescription
      alwaysPrompt: true
      variable: Topic.description
      prompt: |
        üìù **Descri√ß√£o do problema** (obrigat√≥rio):

        ‚ö†Ô∏è **IMPORTANTE:** Forne√ßa uma descri√ß√£o detalhada com pelo menos 50 caracteres.
        
        ‚úÖ **Inclua informa√ß√µes como:**
        - O que exatamente est√° acontecendo?
        - Quando o problema come√ßou?
        - Que a√ß√µes voc√™ j√° tentou?
        - Mensagens de erro (se houver)?

        Descreva detalhadamente o problema ou solicita√ß√£o:
      entity: StringPrebuiltEntity

    # Valida√ß√£o 1: Tamanho m√≠nimo da descri√ß√£o
    - kind: ConditionGroup
      id: ValidateDescriptionLength
      conditions:
        - id: DescriptionTooShort
          condition: =Len(Topic.description) < 50
          actions:
            - kind: SendActivity
              id: DescriptionTooShortMessage
              activity: |
                ‚ùå **Descri√ß√£o muito curta!**
                
                Sua descri√ß√£o tem apenas {Len(Topic.description)} caracteres. 
                Precisamos de pelo menos 50 caracteres para entender melhor o problema.
                
                üìù **Dicas para uma boa descri√ß√£o:**
                - Explique o que est√° acontecendo
                - Mencione quando come√ßou
                - Descreva o que voc√™ j√° tentou fazer
                - Inclua mensagens de erro se houver

            - kind: Question
              id: GetDescriptionRetry
              alwaysPrompt: true
              variable: Topic.description
              prompt: |
                Por favor, forne√ßa uma descri√ß√£o mais detalhada (m√≠nimo 50 caracteres):
              entity: StringPrebuiltEntity

    # Valida√ß√£o 2: Detec√ß√£o de palavras vagas
    - kind: ConditionGroup
      id: ValidateVagueWords
      conditions:
        - id: HasVagueWords
          condition: ="n√£o funciona" in Lower(Topic.description) || "com problema" in Lower(Topic.description) || "n√£o est√° funcionando" in Lower(Topic.description) || "quebrado" in Lower(Topic.description) || "parou" in Lower(Topic.description) || "travou" in Lower(Topic.description)
          actions:
            - kind: SendActivity
              id: VagueWordsMessage
              activity: |
                ‚ö†Ô∏è **Descri√ß√£o pode ser mais espec√≠fica!**
                
                Detectamos termos gen√©ricos em sua descri√ß√£o. Para um atendimento mais r√°pido, 
                seria √∫til ter mais detalhes espec√≠ficos.

            - kind: Question
              id: GetMoreDetails
              alwaysPrompt: true
              variable: Topic.additional_details
              prompt: |
                üìã **Pode fornecer mais detalhes espec√≠ficos?**
                
                Por exemplo:
                - Que mensagem de erro aparece?
                - O problema acontece sempre ou √†s vezes?
                - Desde quando isso est√° acontecendo?
                - Voc√™ consegue reproduzir o problema?
                
                Detalhes adicionais (opcional, mas recomendado):
              entity: StringPrebuiltEntity

            # Combinar descri√ß√£o original com detalhes adicionais
            - kind: SetVariable
              id: CombineDescription
              variable: Topic.description
              value: "=Topic.description & If(IsBlank(Topic.additional_details), \"\", \" | Detalhes adicionais: \" & Topic.additional_details)"

    - kind: Question
      id: GetImpact
      alwaysPrompt: false
      variable: Topic.impact
      prompt: |
        ‚ö° **Impacto** (opcional):

        Qual o impacto deste problema?
        - BAIXO
        - MEDIO  
        - ALTO

        Digite uma das op√ß√µes ou deixe em branco para MEDIO:
      entity: StringPrebuiltEntity

    # Valida√ß√£o 3: Localiza√ß√£o obrigat√≥ria
    - kind: Question
      id: GetLocation
      alwaysPrompt: true
      variable: Topic.location
      prompt: |
        üìç **Localiza√ß√£o** (obrigat√≥rio):

        ‚ö†Ô∏è **IMPORTANTE:** Este campo √© obrigat√≥rio para localizar voc√™ rapidamente.
        
        ‚úÖ **Exemplos v√°lidos:**
        - Sala 101, Andar 2
        - Departamento Financeiro
        - Home Office - Bairro Centro
        - Filial S√£o Paulo - Sala 205

        Onde voc√™ est√° localizado?
      entity: StringPrebuiltEntity

    # Valida√ß√£o da localiza√ß√£o
    - kind: ConditionGroup
      id: ValidateLocation
      conditions:
        - id: LocationEmpty
          condition: =IsBlank(Topic.location) || Len(Trim(Topic.location)) < 3
          actions:
            - kind: SendActivity
              id: LocationEmptyMessage
              activity: |
                ‚ùå **Localiza√ß√£o √© obrigat√≥ria!**
                
                Precisamos saber onde voc√™ est√° para enviar o t√©cnico correto.
                Por favor, forne√ßa pelo menos 3 caracteres.

            - kind: Question
              id: GetLocationRetry
              alwaysPrompt: true
              variable: Topic.location
              prompt: |
                üìç Por favor, informe sua localiza√ß√£o (ex: Sala 101, Departamento TI):
              entity: StringPrebuiltEntity

    # Valida√ß√£o 4: Telefone obrigat√≥rio
    - kind: Question
      id: GetContactPhone
      alwaysPrompt: true
      variable: Topic.contact_phone
      prompt: |
        üìû **Telefone de contato** (obrigat√≥rio):

        ‚ö†Ô∏è **IMPORTANTE:** Precisamos de um telefone para contato em caso de d√∫vidas.
        
        ‚úÖ **Formatos aceitos:**
        - (11) 99999-9999
        - 11999999999
        - +55 11 99999-9999

        Telefone para contato:
      entity: StringPrebuiltEntity

    # Valida√ß√£o do telefone
    - kind: ConditionGroup
      id: ValidatePhone
      conditions:
        - id: PhoneEmpty
          condition: =IsBlank(Topic.contact_phone) || Len(Trim(Topic.contact_phone)) < 8
          actions:
            - kind: SendActivity
              id: PhoneEmptyMessage
              activity: |
                ‚ùå **Telefone √© obrigat√≥rio!**
                
                Precisamos de um telefone v√°lido para contato durante o atendimento.
                O telefone deve ter pelo menos 8 d√≠gitos.

            - kind: Question
              id: GetPhoneRetry
              alwaysPrompt: true
              variable: Topic.contact_phone
              prompt: |
                üìû Por favor, informe seu telefone (ex: (11) 99999-9999):
              entity: StringPrebuiltEntity

    # Mensagem de confirma√ß√£o com resumo
    - kind: SendActivity
      id: ConfirmationMessage
      activity: |
        ‚úÖ **Informa√ß√µes coletadas com sucesso!**
        
        üìã **Resumo do seu chamado:**
        üè∑Ô∏è **Categoria:** {Topic.category_user_friendly}
        üìù **Descri√ß√£o:** {Topic.description}
        ‚ö° **Impacto:** {If(IsBlank(Topic.impact), "MEDIO", Text(Topic.impact))}
        üìç **Localiza√ß√£o:** {Topic.location}
        üìû **Telefone:** {Topic.contact_phone}

    - kind: SendActivity
      id: ProcessingMessage
      activity: |
        ‚è≥ Processando seu chamado...

    - kind: HttpRequestAction
      id: CreateTicketRequest
      method: Post
      url: https://mcp-cau-api.loca.lt/api/create-ticket-complete
      headers:
        Content-Type: application/json; charset=utf-8

      body:
        kind: JsonRequestContent
        content: |
          {
            "categoria": "{Topic.category_user_friendly}",
            "titulo": "Chamado via Copilot Studio",
            "descricao": "{Topic.description}",
            "impacto": "{If(IsBlank(Topic.impact), \"MEDIO\", Text(Topic.impact))}",
            "urgencia": "MEDIA",
            "localizacao": "{Topic.location}",
            "solicitante": "Usuario Copilot Studio",
            "email": "copilot@empresa.com",
            "telefone_contato": "{Topic.contact_phone}"
          }

      response: Topic.ticketResult

    - kind: ConditionGroup
      id: CheckTicketCreation
      conditions:
        - id: TicketSuccess
          condition: =Boolean(Topic.ticketResult.success)
          actions:
            - kind: SendActivity
              id: SuccessMessage
              activity: |
                ‚úÖ **Chamado criado com sucesso!**

                üé´ **N√∫mero do Chamado:** #{Topic.ticketResult.ticket_id}
                üìã **Categoria:** {Topic.ticketResult.category}
                üìù **Descri√ß√£o:** {Topic.description}
                ‚ö° **Impacto:** {Topic.impact}
                üìç **Localiza√ß√£o:** {Topic.location}
                üîç **Trace ID:** {Topic.ticketResult.trace_id}

                Seu chamado foi registrado e ser√° atendido em breve!

      elseActions:
        - kind: SendActivity
          id: ErrorMessage
          activity: |
            ‚ùå **Erro ao criar chamado**

            üîç **Trace ID:** {Topic.ticketResult.trace_id}
            ‚ö†Ô∏è **Erro:** {Topic.ticketResult.error}

            Tente novamente ou entre em contato com o suporte.

    - kind: SendActivity
      id: FinalMessage
      activity: üí¨ Posso ajudar com mais alguma coisa?